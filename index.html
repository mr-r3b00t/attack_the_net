<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attack the Net</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
            background: #0A0F1C; /* TRON dark blue-black */
            color: #00D4FF; /* Neon blue text */
            background-image: linear-gradient(rgba(0, 212, 255, 0.1) 1px, transparent 1px),
                            linear-gradient(90deg, rgba(0, 212, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px; /* Subtle grid for page background */
        }
        .container {
            display: grid;
            grid-template-columns: 70% 30%;
            height: 100%;
            width: 100%;
        }
        #mynetwork {
            border-right: 2px solid #00D4FF; /* Neon blue border */
            overflow: hidden;
            background: #0A0F1C;
            position: relative;
            /* TRON-like perspective grid background */
            background-image: linear-gradient(45deg, rgba(0, 212, 255, 0.2) 1px, transparent 1px),
                            linear-gradient(-45deg, rgba(0, 212, 255, 0.2) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        #mynetwork::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0, 212, 255, 0.1), transparent 70%);
            pointer-events: none; /* Allow clicks to pass through */
        }
        #log {
            padding: 1rem;
            background: rgba(10, 15, 28, 0.8); /* Semi-transparent dark */
            overflow-y: auto;
            max-height: 100%;
            display: flex;
            flex-direction: column;
            border-left: 2px solid #FF4800; /* Neon orange border */
        }
        #log h3 {
            margin: 0 0 1rem;
            font-size: 1.5rem;
            color: #00D4FF;
            text-shadow: 0 0 5px #00D4FF;
            flex-shrink: 0;
        }
        #log-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        #log p {
            margin: 0.5rem 0;
            font-size: 1rem;
            line-height: 1.5;
            color: #FFFFFF;
            text-shadow: 0 0 3px #00D4FF;
        }
        #menu, #social-engineering-menu {
            position: fixed;
            background: rgba(10, 15, 28, 0.9);
            padding: 1rem;
            border: 2px solid #00D4FF;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            box-shadow: 0 0 10px #00D4FF;
        }
        #menu button, #social-engineering-menu button, #controls button {
            display: block;
            margin: 0.5rem 0;
            background: transparent;
            color: #00D4FF;
            border: 1px solid #00D4FF;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-family: 'Orbitron', sans-serif;
            width: 100%;
            text-align: left;
            transition: all 0.3s ease;
        }
        #menu button:hover, #social-engineering-menu button:hover, #controls button:hover {
            background: #00D4FF;
            color: #0A0F1C;
            box-shadow: 0 0 10px #00D4FF;
        }
        #menu button.hidden {
            display: none;
        }
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 15, 28, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: rgba(10, 15, 28, 0.9);
            padding: 2rem;
            border: 2px solid #FF4800;
            border-radius: 5px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 15px #FF4800;
        }
        .modal-content h2 {
            margin: 0 0 1rem;
            font-size: 2rem;
            color: #00D4FF;
            text-shadow: 0 0 5px #00D4FF;
        }
        .modal-content p {
            margin: 0.5rem 0;
            font-size: 1.2rem;
            color: #FFFFFF;
            text-shadow: 0 0 3px #00D4FF;
        }
        .modal-content .button-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        .modal-content button {
            background: transparent;
            color: #00D4FF;
            border: 1px solid #00D4FF;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-family: 'Orbitron', sans-serif;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        .modal-content button:hover {
            background: #00D4FF;
            color: #0A0F1C;
            box-shadow: 0 0 10px #00D4FF;
        }
        .modal-content .tweet-button {
            border-color: #FF4800;
            color: #FF4800;
        }
        .modal-content .tweet-button:hover {
            background: #FF4800;
            color: #0A0F1C;
            box-shadow: 0 0 10px #FF4800;
        }
        .modal-content .start-button {
            border-color: #00D4FF;
            color: #00D4FF;
        }
        .modal-content .start-button:hover {
            background: #00D4FF;
            color: #0A0F1C;
            box-shadow: 0 0 10px #00D4FF;
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 100%;
                grid-template-rows: 60% 40%;
            }
            #mynetwork {
                border-right: none;
                border-bottom: 2px solid #00D4FF;
            }
            #log {
                max-height: 40vh;
                border-left: none;
                border-top: 2px solid #FF4800;
            }
            #controls {
                top: 5px;
                right: 5px;
            }
            .modal-content {
                padding: 1.5rem;
            }
            .modal-content h2 {
                font-size: 1.5rem;
            }
            .modal-content p {
                font-size: 1rem;
            }
            .modal-content .button-container {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
    <script src="https://unpkg.com/vis-network@9.1.0/standalone/umd/vis-network.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="mynetwork"></div>
        <div id="log">
            <h3>Action Log</h3>
            <div id="log-content"></div>
        </div>
    </div>
    <div id="controls">
        <button onclick="togglePathfindingMode()" aria-label="Find path between two nodes">Find Path</button>
    </div>
    <div id="menu">
        <button onclick="performAction('scan')" aria-label="Scan node for services">Scan</button>
        <button id="exploit-button" class="hidden" onclick="performAction('exploit')" aria-label="Exploit node to compromise it">Exploit</button>
        <button id="privesc-button" class="hidden" onclick="performAction('privesc')" aria-label="Perform privilege escalation on Domain Controller">Privesc</button>
        <button id="pwn-button" class="hidden" onclick="performAction('pwn')" aria-label="PWN Domain Controller">PWN</button>
        <button id="delete-button" class="hidden" onclick="performAction('delete')" aria-label="Delete Backup Data">Delete</button>
        <button onclick="closeMenu()" aria-label="Close action menu">Close</button>
    </div>
    <div id="social-engineering-menu">
        <button onclick="performSocialEngineeringExploit()" aria-label="Exploit node with social engineering">Exploit with Social Engineering</button>
        <button onclick="closeSocialEngineeringMenu()" aria-label="Close social engineering menu">Close</button>
    </div>
    <div id="intro-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2>Ready to Hack the NET?</h2>
            <button class="start-button" onclick="startGame()">START</button>
        </div>
    </div>
    <div id="win-modal" class="modal">
        <div class="modal-content">
            <h2>Mission Success</h2>
            <p>Grid Conquered</p>
            <p id="time-taken">Time Taken: --:--</p>
            <p id="score">Time-Based Score: 0</p>
            <p id="points">Points: 0</p>
            <div class="button-container">
                <button onclick="restartGame()">Restart</button>
                <button class="tweet-button" id="tweet-button">Tweet Score</button>
            </div>
        </div>
    </div>
    <script>
        // Audio setup
        const backgroundAudio = new Audio('/assets/background.mp3');
        backgroundAudio.loop = true;
        backgroundAudio.volume = 0.3; // Lower volume for background
        const selectAudio = new Audio('/assets/select.mp3');
        selectAudio.volume = 0.7; // Medium volume for selection
        const exploitAudio = new Audio('/assets/exploit.mp3');
        exploitAudio.volume = 0.9; // Louder for impactful action

        // Play background audio when game starts
        function playBackgroundAudio() {
            backgroundAudio.play().catch(error => {
                console.error('Background audio playback failed:', error);
            });
        }

        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }

        // Define nodes
        var nodes = new vis.DataSet([
            { id: 1, label: 'Internet', originalLabel: 'Internet', group: 'internet', compromised: true, contains_tools: ['Web Exploit'], exploitable: false },
            { id: 2, label: '', originalLabel: 'Web Server', group: 'dmz', services: ['HTTP'], required_tool: 'Web Exploit', contains_tools: ['Email Credential'], exploitable: true },
            { id: 3, label: '', originalLabel: 'Email Server', group: 'dmz', services: ['SMTP'], required_tool: 'Email Credential', contains_tools: ['VPN Credential'], exploitable: true },
            { id: 4, label: '', originalLabel: 'VPN Server', group: 'dmz', services: ['VPN'], required_tool: 'VPN Credential', contains_tools: ['HR Credential', 'Firewall Exploit'], exploitable: true },
            { id: 5, label: '', originalLabel: 'Firewall', group: 'firewall', services: [], required_tool: 'Firewall Exploit', contains_tools: [], exploitable: true, hidden: true },
            { id: 6, label: '', originalLabel: 'Domain Controller 1', group: 'internal', services: ['RDP'], required_tool: 'DC Credential', contains_tools: [], exploitable: true, hidden: true, privescDone: false, pwned: false },
            { id: 7, label: '', originalLabel: 'Domain Controller 2', group: 'internal', services: ['RDP'], required_tool: 'DC Credential', contains_tools: [], exploitable: true, hidden: true, privescDone: false, pwned: false },
            { id: 8, label: '', originalLabel: 'File Server', group: 'internal', services: [], required_tool: 'User Credential', contains_tools: [], exploitable: true, hidden: true },
            { id: 9, label: '', originalLabel: 'HR Web Server', group: 'internal', services: ['HTTP', 'RDP'], required_tool: 'HR Credential', contains_tools: ['DB Credential'], exploitable: true, hidden: true },
            { id: 10, label: '', originalLabel: 'HR Database Server', group: 'internal', services: [], required_tool: 'DB Credential', contains_tools: ['User Credential'], exploitable: true, hidden: true },
            { id: 11, label: '', originalLabel: 'ERP', group: 'internal', services: ['HTTP'], required_tool: 'DC Credential', contains_tools: [], exploitable: true, hidden: true },
            { id: 12, label: '', originalLabel: 'CRM', group: 'internal', services: ['HTTP'], required_tool: 'DC Credential', contains_tools: [], exploitable: true, hidden: true },
            { id: 13, label: '', originalLabel: 'Workstation', group: 'internal', services: ['RDP'], required_tool: 'VPN Credential', contains_tools: ['Admin Credential'], exploitable: true, hidden: true },
            { id: 14, label: '', originalLabel: 'IT Admin Machine', group: 'internal', services: ['RDP'], required_tool: 'Admin Credential', contains_tools: ['DC Credential'], exploitable: true, hidden: true },
            { id: 15, label: '', originalLabel: 'Backup Server', group: 'internal', services: [], required_tool: 'DC Credential', contains_tools: [], exploitable: true, hidden: true },
            { id: 16, label: '', originalLabel: 'Helpdesk', group: 'dmz', services: ['Web'], required_tool: null, contains_tools: ['VPN Credential'], exploitable: true },
            { id: 17, label: '', originalLabel: 'Hypervisor', group: 'internal', services: ['VMware API'], required_tool: 'Admin Credential', contains_tools: [], exploitable: true, hidden: true },
            { id: 18, label: '', originalLabel: 'Backup Data', group: 'internal', services: [], required_tool: null, contains_tools: [], exploitable: false, hidden: true, deleted: false }
        ]);

        // Define edges
        var edges = new vis.DataSet([
            { id: '1-2', from: 1, to: 2, traversable: true },
            { id: '1-3', from: 1, to: 3, traversable: true },
            { id: '1-4', from: 1, to: 4, traversable: true },
            { id: '1-16', from: 1, to: 16, traversable: true }, // Internet to Helpdesk
            { id: '2-5', from: 2, to: 5, hidden: true, traversable: false }, // Non-traversable
            { id: '3-5', from: 3, to: 5, hidden: true, traversable: false }, // Non-traversable
            { id: '4-5', from: 4, to: 5, hidden: true, traversable: true },
            { id: '5-6', from: 5, to: 6, hidden: true, traversable: true },
            { id: '5-7', from: 5, to: 7, hidden: true, traversable: true },
            { id: '5-8', from: 5, to: 8, hidden: true, traversable: true },
            { id: '5-9', from: 5, to: 9, hidden: true, traversable: true },
            { id: '5-11', from: 5, to: 11, hidden: true, traversable: true },
            { id: '5-12', from: 5, to: 12, hidden: true, traversable: true },
            { id: '5-13', from: 5, to: 13, hidden: true, traversable: true },
            { id: '5-14', from: 5, to: 14, hidden: true, traversable: true },
            { id: '5-15', from: 5, to: 15, hidden: true, traversable: true },
            { id: '9-10', from: 9, to: 10, hidden: true, traversable: true },
            { id: '14-17', from: 14, to: 17, hidden: true, traversable: true }, // IT Admin Machine to Hypervisor
            { id: '15-18', from: 15, to: 18, hidden: true, traversable: true } // Backup Server to Backup Data
        ]);

        // Initialize network
        var container = document.getElementById('mynetwork');
        var data = { nodes: nodes, edges: edges };
        var options = {
            nodes: {
                shape: 'dot',
                size: 15,
                font: { size: 12, color: '#FFFFFF', face: 'Orbitron' },
                borderWidth: 2,
                shadow: {
                    enabled: true,
                    color: 'rgba(0, 212, 255, 0.5)',
                    size: 5,
                    x: 0,
                    y: 0
                }
            },
            groups: {
                internet: { color: { background: '#FF4800', border: '#CC3700' }, shadow: { color: '#FF4800' } }, // Neon orange
                dmz: { color: { background: '#00D4FF', border: '#0099CC' }, shadow: { color: '#00D4FF' } }, // Neon blue
                firewall: { color: { background: '#FFFFFF', border: '#CCCCCC' }, shadow: { color: '#FFFFFF' } }, // White
                internal: { color: { background: '#FF4800', border: '#CC3700' }, shadow: { color: '#FF4800' } } // Neon orange
            },
            edges: {
                color: { color: '#00D4FF', highlight: '#FF4800' },
                width: 2,
                dashes: [5, 5], // Dashed lines for TRON effect
                shadow: {
                    enabled: true,
                    color: 'rgba(0, 212, 255, 0.5)',
                    size: 3
                }
            },
            interaction: {
                hover: true,
                zoomView: true,
                dragView: true
            },
            physics: {
                enabled: true,
                stabilization: { iterations: 50 },
                barnesHut: {
                    gravitationalConstant: -2000,
                    springLength: 80
                }
            },
            layout: {
                improvedLayout: true
            }
        };
        var network = new vis.Network(container, data, options);
        network.fit();

        // Player state
        var player = {
            position: 1,
            tools: ['Web Exploit'],
            compromisedNodes: [1],
            reachableNodes: [2, 3, 4, 16], // Include Helpdesk
            scannedNodes: [],
            startTime: null,
            points: 0, // Track points
            pathfindingMode: false, // Track pathfinding mode
            selectedNodes: [] // Track selected nodes for pathfinding
        };

        // Log function
        function addToLog(message) {
            var logContent = document.getElementById('log-content');
            var entry = document.createElement('p');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContent.appendChild(entry);
            logContent.scrollTo({ top: logContent.scrollHeight, behavior: 'smooth' });
        }

        // Format time as MM:SS
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Calculate time-based score
        function calculateScore(timeTaken) {
            const maxScore = 100000;
            const score = Math.max(0, maxScore - timeTaken);
            return Math.floor(score);
        }

        // Start game
        function startGame() {
            var introModal = document.getElementById('intro-modal');
            introModal.style.display = 'none';
            player.startTime = Date.now();
            playBackgroundAudio(); // Start background music
            addToLog('Game started. You are on the Internet. Objective: Compromise the File Server.');
            addToLog(`Initial tools: ${player.tools.join(', ') || 'None'}.`);
            addToLog(`Can initially attack: Node 2, Node 3, Node 4, Node 16.`);
            addToLog('Left-click a node to open the context menu. Scan nodes to reveal their identity and services (5 points), then exploit them (10 points, 20 for Helpdesk, 50 for Hypervisor; Domain Controllers turn orange on exploit). For Domain Controllers (Nodes 6, 7), after exploiting, perform Privesc (5 points) and then PWN to fully compromise them (turns red). Compromise Backup Server (Node 15) to access Backup Data (Node 18), then Delete it (150 points, turns red). Click "Find Path" to select two nodes and see the kill chain to reach one from the other (all path edges, including the last, turn red for 10 seconds; only VPN Server (Node 4) leads to Firewall (Node 5)). Right-click the Helpdesk (Node 16) for a social engineering exploit. Start with Node 2, Node 3, Node 4, or Node 16 to reveal and attack the Firewall via VPN Server. Compromise the Firewall to access the internal network, then exploit HR Web Server and HR Database Server to obtain User Credential, and finally compromise File Server to win.');
        }

        // Show win modal
        function showWinModal(timeTaken, score, points) {
            var modal = document.getElementById('win-modal');
            var timeDisplay = document.getElementById('time-taken');
            var scoreDisplay = document.getElementById('score');
            var pointsDisplay = document.getElementById('points');
            var tweetButton = document.getElementById('tweet-button');
            timeDisplay.textContent = `Time Taken: ${formatTime(timeTaken)}`;
            scoreDisplay.textContent = `Time-Based Score: ${score.toLocaleString()}`;
            pointsDisplay.textContent = `Action Points: ${points.toLocaleString()}`;
            const tweetText = `I conquered the NET! Time: ${formatTime(timeTaken)}, Time Score: ${score.toLocaleString()}, Action Points: ${points.toLocaleString()}! Play here: https://mr-r3b00t.github.io/attack_the_net/ #Hacking #game`;
            const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;
            tweetButton.onclick = () => window.open(tweetUrl, '_blank');
            modal.style.display = 'flex';
            backgroundAudio.pause(); // Pause background music on win
        }

        // Restart game
        function restartGame() {
            backgroundAudio.pause(); // Pause background music
            location.reload();
        }

        // Pathfinding functions
        function togglePathfindingMode() {
            player.pathfindingMode = !player.pathfindingMode;
            player.selectedNodes = [];
            network.unselectAll();
            network.selectNodes([]);
            if (player.pathfindingMode) {
                addToLog('Pathfinding mode activated. Click the start node, then the end node.');
                closeMenu();
                closeSocialEngineeringMenu();
                resetEdgeColors();
            } else {
                addToLog('Pathfinding mode deactivated.');
                resetEdgeColors();
                closeMenu();
                closeSocialEngineeringMenu();
            }
        }

        function resetEdgeColors() {
            edges.update(edges.get().map(edge => ({ id: edge.id, color: { color: '#00D4FF' } })));
        }

        function findPath(startId, endId) {
            const toolSources = {
                'Web Exploit': 1,
                'Email Credential': 2,
                'VPN Credential': [3, 16],
                'HR Credential': 4,
                'Firewall Exploit': 4,
                'Admin Credential': 13,
                'DC Credential': 14,
                'DB Credential': 9,
                'User Credential': 10
            };

            const queue = [{ path: [startId], tools: [...player.tools] }];
            const visited = new Set();
            while (queue.length > 0) {
                const { path, tools } = queue.shift();
                const nodeId = path[path.length - 1];
                if (nodeId === endId) {
                    return path;
                }
                const stateKey = `${nodeId}:${tools.sort().join(',')}`;
                if (!visited.has(stateKey)) {
                    visited.add(stateKey);
                    const node = nodes.get(nodeId);
                    const neighbors = edges.get().filter(edge => 
                        !edge.hidden && 
                        edge.traversable !== false &&
                        (edge.from === nodeId || edge.to === nodeId)
                    ).map(edge => edge.from === nodeId ? edge.to : edge.from)
                    .filter(id => {
                        const neighbor = nodes.get(id);
                        if (!neighbor.required_tool) return true;
                        if (tools.includes(neighbor.required_tool)) return true;
                        const sourceId = toolSources[neighbor.required_tool];
                        if (Array.isArray(sourceId)) {
                            return sourceId.some(sid => path.includes(sid));
                        }
                        return sourceId && path.includes(sourceId);
                    });
                    for (const neighbor of neighbors) {
                        const neighborNode = nodes.get(neighbor);
                        let newTools = [...tools];
                        if (neighborNode.contains_tools && neighborNode.contains_tools.length > 0) {
                            newTools = [...newTools, ...neighborNode.contains_tools];
                        }
                        if (neighbor === 14 || neighbor === 17) {
                            if (!path.includes(13) && !tools.includes('Admin Credential')) {
                                const workstationPath = [...path, 13];
                                queue.push({ path: workstationPath, tools: [...newTools, 'Admin Credential'] });
                                continue;
                            }
                        }
                        queue.push({ path: [...path, neighbor], tools: newTools });
                    }
                }
            }
            return null;
        }

        function getRequiredSteps(path) {
            const steps = [];
            const toolsNeeded = new Set();
            let currentTools = [...player.tools];

            for (let i = 0; i < path.length; i++) {
                const nodeId = path[i];
                const node = nodes.get(nodeId);
                const nodeSteps = [];

                if (nodeId === 1) continue;

                if (!player.scannedNodes.includes(nodeId)) {
                    nodeSteps.push(`Scan ${node.originalLabel} to reveal services (5 points).`);
                }

                if (node.exploitable && !node.compromised) {
                    if (nodeId === 16) {
                        nodeSteps.push(`Exploit ${node.originalLabel} with social engineering (20 points).`);
                        if (node.contains_tools.length > 0) {
                            currentTools = [...currentTools, ...node.contains_tools];
                        }
                    } else if (node.required_tool && !currentTools.includes(node.required_tool)) {
                        nodeSteps.push(`Cannot exploit ${node.originalLabel}: Missing required tool ${node.required_tool}.`);
                        toolsNeeded.add(node.required_tool);
                    } else {
                        nodeSteps.push(`Exploit ${node.originalLabel} (${nodeId === 17 ? 50 : 10} points).`);
                        if (node.contains_tools.length > 0) {
                            currentTools = [...currentTools, ...node.contains_tools];
                        }
                    }
                }

                if ((nodeId === 6 || nodeId === 7) && node.compromised && !node.pwned) {
                    if (!node.privescDone) {
                        nodeSteps.push(`Perform privilege escalation on ${node.originalLabel} (5 points).`);
                    }
                    if (!node.pwned) {
                        nodeSteps.push(`PWN ${node.originalLabel} to fully compromise it.`);
                    }
                }

                if (nodeId === 18 && !node.deleted) {
                    nodeSteps.push(`Delete ${node.originalLabel} (150 points).`);
                }

                if (nodeSteps.length > 0) {
                    steps.push(`Node ${nodeId} (${node.originalLabel}):`);
                    steps.push(...nodeSteps.map(step => `  - ${step}`));
                }
            }

            if (toolsNeeded.size > 0) {
                steps.unshift('Required tools not currently available:');
                for (const tool of toolsNeeded) {
                    const toolSource = nodes.get().find(n => n.contains_tools && n.contains_tools.includes(tool));
                    if (toolSource) {
                        steps.push(`  - Obtain ${tool} by exploiting ${toolSource.originalLabel} (Node ${toolSource.id}).`);
                    } else {
                        steps.push(`  - ${tool} (source unknown).`);
                    }
                }
            }

            return steps;
        }

        function highlightPath(path) {
            const pathEdges = [];
            for (let i = 0; i < path.length - 1; i++) {
                const from = path[i];
                const to = path[i + 1];
                const edge = edges.get().find(e => 
                    ((e.from === from && e.to === to) || (e.from === to && e.to === from))
                );
                if (edge) {
                    pathEdges.push({ id: edge.id, color: { color: '#FF4800' } });
                }
            }
            edges.update(pathEdges);

            setTimeout(() => {
                resetEdgeColors();
                network.unselectAll();
                network.selectNodes([]);
            }, 10000);
        }

        let isMenuOpening = false;

        // Handle node left-click
        network.on('click', function(params) {
            const seMenu = document.getElementById('social-engineering-menu');
            if (seMenu.style.display === 'block') {
                return;
            }

            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const nodeLabel = nodes.get(nodeId).originalLabel;
                console.log(`Left-clicked node ${nodeId}: ${nodeLabel}`);
                selectAudio.play().catch(error => {
                    console.error('Select audio playback failed:', error);
                });

                if (player.pathfindingMode) {
                    player.selectedNodes.push(nodeId);
                    addToLog(`Selected node ${nodeId} (${nodeLabel}) for pathfinding.`);
                    if (player.selectedNodes.length === 2) {
                        const [startId, endId] = player.selectedNodes;
                        const startNode = nodes.get(startId);
                        const endNode = nodes.get(endId);

                        let canFindPath = true;
                        if (endNode.group === 'internal' && !player.compromisedNodes.includes(5)) {
                            addToLog(`Cannot find path to ${endNode.originalLabel} (Node ${endId}). Compromise the Firewall (Node 5) to access the internal network.`);
                            canFindPath = false;
                        }

                        if (canFindPath) {
                            const path = findPath(startId, endId);
                            if (path) {
                                const startLabel = nodes.get(startId).originalLabel;
                                const endLabel = nodes.get(endId).originalLabel;
                                addToLog(`Path from ${startLabel} (Node ${startId}) to ${endLabel} (Node ${endId}): ${path.map(id => nodes.get(id).originalLabel).join(' -> ')}`);
                                const steps = getRequiredSteps(path);
                                if (steps.length > 0) {
                                    addToLog('Required steps:');
                                    steps.forEach(step => addToLog(step));
                                } else {
                                    addToLog('No additional steps required (all nodes already compromised or accessible).');
                                }
                                highlightPath(path);
                            } else {
                                addToLog(`No valid path found from ${nodes.get(startId).originalLabel} (Node ${startId}) to ${nodes.get(endId).originalLabel} (Node ${endId}). Ensure intermediate nodes are accessible.`);
                            }
                        }

                        player.pathfindingMode = false;
                        player.selectedNodes = [];
                        closeMenu();
                        closeSocialEngineeringMenu();
                        network.unselectAll();
                        network.selectNodes([]);
                        addToLog('Pathfinding mode deactivated.');
                    }
                } else {
                    if (nodeId === 1) {
                        console.log('Clicked Internet node; no menu displayed.');
                        return;
                    }
                    showMenu(nodeId, params.event);
                }
            } else {
                closeMenu();
                closeSocialEngineeringMenu();
                network.unselectAll();
                network.selectNodes([]);
            }
        });

        // Handle node right-click
        network.on('oncontext', function(params) {
            params.event.preventDefault();
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                if (nodeId === 16) {
                    console.log(`Right-clicked node ${nodeId}: Helpdesk`);
                    selectAudio.play().catch(error => {
                        console.error('Select audio playback failed:', error);
                    });
                    closeMenu();
                    showSocialEngineeringMenu(nodeId, params.event);
                    network.selectNodes([nodeId]);
                }
            } else {
                closeMenu();
                closeSocialEngineeringMenu();
            }
        });

        document.addEventListener('click', function(event) {
            if (isMenuOpening) {
                isMenuOpening = false;
                return;
            }
            const menu = document.getElementById('menu');
            const seMenu = document.getElementById('social-engineering-menu');
            if (menu.style.display === 'block' && !menu.contains(event.target)) {
                console.log('Menu closed');
                closeMenu();
                network.unselectAll();
                network.selectNodes([]);
            }
            if (seMenu.style.display === 'block' && !seMenu.contains(event.target)) {
                console.log('Social Engineering Menu closed');
                closeSocialEngineeringMenu();
                network.unselectAll();
                network.selectNodes([]);
            }
        });

        function showMenu(nodeId, event) {
            isMenuOpening = true;
            const menu = document.getElementById('menu');
            const exploitButton = document.getElementById('exploit-button');
            const privescButton = document.getElementById('privesc-button');
            const pwnButton = document.getElementById('pwn-button');
            const deleteButton = document.getElementById('delete-button');
            const node = nodes.get(nodeId);

            if (player.scannedNodes.includes(nodeId) && !(node.pwned && (nodeId === 6 || nodeId === 7)) && !(node.deleted && nodeId === 18)) {
                exploitButton.classList.remove('hidden');
            } else {
                exploitButton.classList.add('hidden');
            }

            if ((nodeId === 6 || nodeId === 7) && node.compromised && !node.privescDone) {
                privescButton.classList.remove('hidden');
            } else {
                privescButton.classList.add('hidden');
            }

            if ((nodeId === 6 || nodeId === 7) && node.privescDone && !node.pwned) {
                pwnButton.classList.remove('hidden');
            } else {
                pwnButton.classList.add('hidden');
            }

            if (nodeId === 18 && player.scannedNodes.includes(nodeId) && !node.deleted) {
                deleteButton.classList.remove('hidden');
            } else {
                deleteButton.classList.add('hidden');
            }

            menu.style.left = '10px';
            menu.style.top = '10px';
            menu.style.display = 'block';
            menu.dataset.nodeId = nodeId;
            console.log(`Menu shown for node ${nodeId}: ${nodes.get(nodeId).originalLabel}`);
            setTimeout(() => { isMenuOpening = false; }, 0);
        }

        function showSocialEngineeringMenu(nodeId, event) {
            isMenuOpening = true;
            const menu = document.getElementById('social-engineering-menu');
            menu.style.left = '10px';
            menu.style.top = '50px';
            menu.style.display = 'block';
            menu.dataset.nodeId = nodeId;
            console.log(`Social Engineering Menu shown for node ${nodeId}: Helpdesk`);
            setTimeout(() => { isMenuOpening = false; }, 0);
        }

        function closeMenu() {
            const menu = document.getElementById('menu');
            if (menu.style.display === 'block') {
                console.log('Menu closed');
                menu.style.display = 'none';
            }
        }

        function closeSocialEngineeringMenu() {
            const menu = document.getElementById('social-engineering-menu');
            if (menu.style.display === 'block') {
                console.log('Social Engineering Menu closed');
                menu.style.display = 'none';
            }
        }

        function updateReachableNodes(newNodeId) {
            const newReachable = edges.get().filter(edge =>
                edge.from === newNodeId || edge.to === newNodeId
            ).map(edge =>
                edge.from === newNodeId ? edge.to : edge.from
            ).filter(id => {
                const node = nodes.get(id);
                if (node.group === 'internal' && !player.compromisedNodes.includes(5)) {
                    return false;
                }
                return !player.compromisedNodes.includes(id) && !node.hidden && !(node.deleted && id === 18);
            });
            player.reachableNodes = [...new Set([...player.reachableNodes, ...newReachable])];
            const newNodeLabels = newReachable.map(id => nodes.get(id).originalLabel).join(', ');
            if (newNodeLabels) {
                addToLog(`Can now attack: ${newNodeLabels}.`);
            }
        }

        function isReachable(nodeId) {
            return player.reachableNodes.includes(nodeId) || player.compromisedNodes.includes(nodeId);
        }

        function hasDomainControllerCompromised() {
            return (nodes.get(6).pwned || nodes.get(7).pwned);
        }

        function performAction(action) {
            const nodeId = parseInt(document.getElementById('menu').dataset.nodeId);
            const node = nodes.get(nodeId);
            let message = '';

            console.log(`Action performed: ${action} on node ${nodeId}: ${node.originalLabel}`);

            if (!isReachable(nodeId) && action !== 'scan') {
                message = `You cannot interact with this node. Compromise more nodes to expand your reach.`;
            } else if (node.group === 'internal' && !player.compromisedNodes.includes(5) && action !== 'scan') {
                message = `Cannot perform ${action} on this node. Compromise the Firewall to access the internal network.`;
            } else {
                switch (action) {
                    case 'scan':
                        if (!player.scannedNodes.includes(nodeId)) {
                            player.scannedNodes.push(nodeId);
                            nodes.update({ id: nodeId, label: node.originalLabel });
                            player.points += 5;
                            message = `Scanning ${node.originalLabel}... Found services: ${node.services.length > 0 ? node.services.join(', ') : 'None'}. (+5 points)`;
                            addToLog(`Earned 5 points for scanning ${node.originalLabel}. Total points: ${player.points}`);
                        } else {
                            message = `${node.originalLabel} has already been scanned. Services: ${node.services.length > 0 ? node.services.join(', ') : 'None'}.`;
                        }
                        break;
                    case 'exploit':
                        if (!player.scannedNodes.includes(nodeId)) {
                            message = `Cannot exploit ${node.originalLabel || 'this node'}. You must scan it first.`;
                        } else if (nodeId === 16) {
                            message = `Cannot exploit ${node.originalLabel} with standard methods. Use social engineering (right-click).`;
                        } else if (!node.exploitable) {
                            message = `${node.originalLabel} cannot be exploited.`;
                        } else if (node.compromised) {
                            message = `${node.originalLabel} is already compromised.`;
                        } else if (node.required_tool && !player.tools.includes(node.required_tool)) {
                            message = `Cannot exploit ${node.originalLabel}. Missing required tool: ${node.required_tool}. Try exploiting other nodes to obtain it.`;
                        } else {
                            node.compromised = true;
                            player.compromisedNodes.push(nodeId);
                            const exploitColor = (nodeId === 6 || nodeId === 7) ? 
                                { background: '#FF4800', border: '#CC3700' } : 
                                { background: '#FF0000', border: '#CC0000' };
                            nodes.update({ id: nodeId, color: exploitColor });
                            const pointsAwarded = nodeId === 17 ? 50 : 10;
                            player.points += pointsAwarded;
                            exploitAudio.play().catch(error => {
                                console.error('Exploit audio playback failed:', error);
                            });
                            if (node.contains_tools.length > 0) {
                                player.tools = player.tools.concat(node.contains_tools);
                                message = `Exploited ${node.originalLabel}! Gained: ${node.contains_tools.join(', ')}. (+${pointsAwarded} points)`;
                            } else {
                                message = `Exploited ${node.originalLabel}! Node compromised. (+${pointsAwarded} points)`;
                            }
                            addToLog(`Earned ${pointsAwarded} points for exploiting ${node.originalLabel}. Total points: ${player.points}`);
                            if (nodeId === 4) {
                                nodes.update({ id: 5, hidden: false });
                                edges.update([
                                    { id: '2-5', hidden: false },
                                    { id: '3-5', hidden: false },
                                    { id: '4-5', hidden: false }
                                ]);
                                player.reachableNodes.push(5);
                                addToLog('Firewall discovered! It can now be attacked after scanning.');
                            } else if (nodeId === 5) {
                                nodes.update([
                                    { id: 6, hidden: false },
                                    { id: 7, hidden: false },
                                    { id: 8, hidden: false },
                                    { id: 9, hidden: false },
                                    { id: 10, hidden: false },
                                    { id: 11, hidden: false },
                                    { id: 12, hidden: false },
                                    { id: 13, hidden: false },
                                    { id: 14, hidden: false },
                                    { id: 15, hidden: false },
                                    { id: 17, hidden: false }
                                ]);
                                edges.update([
                                    { id: '5-6', hidden: false },
                                    { id: '5-7', hidden: false },
                                    { id: '5-8', hidden: false },
                                    { id: '5-9', hidden: false },
                                    { id: '5-11', hidden: false },
                                    { id: '5-12', hidden: false },
                                    { id: '5-13', hidden: false },
                                    { id: '5-14', hidden: false },
                                    { id: '5-15', hidden: false },
                                    { id: '9-10', hidden: false },
                                    { id: '14-17', hidden: false }
                                ]);
                                addToLog('Firewall compromised! Internal network discovered, including Hypervisor, accessible after scanning.');
                            } else if (nodeId === 15) {
                                nodes.update({ id: 18, hidden: false });
                                edges.update({ id: '15-18', hidden: false });
                                player.reachableNodes.push(18);
                                addToLog('Backup Data discovered! It can now be attacked after scanning.');
                            } else if (nodeId === 8) {
                                const timeTaken = (Date.now() - player.startTime) / 1000;
                                const score = calculateScore(timeTaken);
                                message = `File Server compromised! Mission accomplished. (+${pointsAwarded} points)`;
                                showWinModal(timeTaken, score, player.points);
                            }
                            updateReachableNodes(nodeId);
                        }
                        break;
                    case 'privesc':
                        if (nodeId !== 6 && nodeId !== 7) {
                            message = `Privilege escalation is only applicable to Domain Controllers.`;
                        } else if (!node.compromised) {
                            message = `Cannot perform privilege escalation on ${node.originalLabel}. Exploit it first.`;
                        } else if (node.privescDone) {
                            message = `Privilege escalation already performed on ${node.originalLabel}.`;
                        } else {
                            node.privescDone = true;
                            player.points += 5;
                            message = `Privilege escalation successful on ${node.originalLabel}! (+5 points)`;
                            addToLog(`Earned 5 points for privilege escalation on ${node.originalLabel}. Total points: ${player.points}`);
                        }
                        break;
                    case 'pwn':
                        if (nodeId !== 6 && nodeId !== 7) {
                            message = `PWN is only applicable to Domain Controllers.`;
                        } else if (!node.privescDone) {
                            message = `Cannot PWN ${node.originalLabel}. Perform privilege escalation first.`;
                        } else if (node.pwned) {
                            message = `${node.originalLabel} is already fully compromised (pwned).`;
                        } else {
                            node.pwned = true;
                            nodes.update({ id: nodeId, color: { background: '#FF0000', border: '#CC0000' } });
                            message = `PWNed ${node.originalLabel}! Domain Controller fully compromised.`;
                            addToLog(`Domain Controller ${node.originalLabel} fully compromised (pwned).`);
                        }
                        break;
                    case 'delete':
                        if (nodeId !== 18) {
                            message = `Delete is only applicable to Backup Data.`;
                        } else if (!player.scannedNodes.includes(nodeId)) {
                            message = `Cannot delete ${node.originalLabel}. You must scan it first.`;
                        } else if (node.deleted) {
                            message = `${node.originalLabel} has already been deleted.`;
                        } else {
                            node.deleted = true;
                            nodes.update({ id: nodeId, color: { background: '#FF0000', border: '#CC0000' } });
                            player.points += 150;
                            message = `Deleted ${node.originalLabel}! Backup data destroyed. (+150 points)`;
                            addToLog(`Earned 150 points for deleting ${node.originalLabel}. Total points: ${player.points}`);
                        }
                        break;
                }
            }

            addToLog(message);
            closeMenu();
        }

        function performSocialEngineeringExploit() {
            const nodeId = parseInt(document.getElementById('social-engineering-menu').dataset.nodeId);
            const node = nodes.get(nodeId);
            let message = '';

            console.log(`Social Engineering Exploit performed on node ${nodeId}: ${node.originalLabel}`);

            if (!isReachable(nodeId)) {
                message = `You cannot interact with this node. Compromise more nodes to expand your reach.`;
            } else if (!player.scannedNodes.includes(nodeId)) {
                message = `Cannot exploit ${node.originalLabel} with social engineering. You must scan it first.`;
            } else if (node.compromised) {
                message = `${node.originalLabel} is already compromised.`;
            } else {
                node.compromised = true;
                player.compromisedNodes.push(nodeId);
                nodes.update({ id: nodeId, color: { background: '#FF0000', border: '#CC0000' } });
                player.points += 20;
                exploitAudio.play().catch(error => {
                    console.error('Exploit audio playback failed:', error);
                });
                if (node.contains_tools.length > 0) {
                    player.tools = player.tools.concat(node.contains_tools);
                    message = `Social engineering exploit on ${node.originalLabel} succeeded! Gained: ${node.contains_tools.join(', ')}. (+20 points)`;
                } else {
                    message = `Social engineering exploit on ${node.originalLabel} succeeded! Node compromised. (+20 points)`;
                }
                addToLog(`Earned 20 points for social engineering exploit on ${node.originalLabel}. Total points: ${player.points}`);
                updateReachableNodes(nodeId);
            }

            addToLog(message);
            closeSocialEngineeringMenu();
        }
    </script>
</body>
</html>
